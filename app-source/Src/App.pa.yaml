# ************************************************************************************************
# Warning: YAML source code for Canvas Apps should only be used to review changes made within Power Apps Studio and for minor edits (Preview).
# Use the maker portal to create and edit your Power Apps.
# 
# The schema file for Canvas Apps is available at https://go.microsoft.com/fwlink/?linkid=2304907
# 
# For more information, visit https://go.microsoft.com/fwlink/?linkid=2292623
# ************************************************************************************************
App:
  Properties:
    OnStart: "=//Set(_currentId, Blank());\r\nSet(varEditMode, false);\r\nSet(varCurrentScreen, \"scrAllDeliverables\");\r\n\r\n// Find current staff record\r\nSet(\r\n   varCurrentStaff,\r\n   LookUp(Staff, Email = User().Email)\r\n);\r\n// Is this user an Admin?\r\nSet(\r\n   varIsAdmin,\r\n   !IsBlank(varCurrentStaff) &&\r\n   varCurrentStaff.Role.Value = \"Admin\"\r\n);\r\n\r\n\r\n// 1. Cache current user\r\nSet(\r\n   varCurrentUser,\r\n   User()\r\n);\r\n// 2. See if this user already exists in Staff\r\nSet(\r\n   varExistingStaff,\r\n   LookUp(\r\n       Staff,\r\n       Email = varCurrentUser.Email\r\n   )\r\n);\r\n// 3. If not, create a default Staff record\r\nIf(\r\n   IsBlank(varExistingStaff),\r\n   Patch(\r\n       Staff,\r\n       Defaults(Staff),\r\n       {\r\n           // SharePoint Title field â€“ use name\r\n           //Title: varCurrentUser.FullName,\r\n           FullName: varCurrentUser.FullName,\r\n           Email: varCurrentUser.Email,\r\n           Active: true,\r\n           Role: {Value:\"Member\"}        // must match an existing Role choice value\r\n           // Workstreams left blank for now\r\n       }\r\n   )\r\n);\r\n\r\nClearCollect(\r\n    NavCollection,\r\n    {\r\n        ItemKey: \"scrAllDeliverables\",\r\n        ItemDisplayName: \"All Deliverables\",\r\n        ItemIconName: \"Home\",\r\n        ItemScreen: scrAllDeliverables,\r\n        ItemType: \"Button\",\r\n        ItemOpen: false,\r\n        ItemParentKey: Blank()\r\n    },\r\n    {\r\n        ItemKey: \"My Dashboard\",\r\n        ItemDisplayName: \"My Dashboard\",\r\n        ItemIconName: \"GridDots\",\r\n        ItemScreen: scrMyDashboard,\r\n        ItemType: \"Button\",\r\n        ItemOpen: false,\r\n        ItemParentKey: Blank()\r\n    },\r\n    {\r\n        ItemKey: \"Executive Dashboard\",\r\n        ItemDisplayName: \"Executive Dashboard\",\r\n        ItemIconName: \"AppsList\",\r\n        ItemScreen: scrExecutiveDashboard,\r\n        ItemType: \"Button\",\r\n        ItemOpen: false,\r\n        ItemParentKey: Blank()\r\n    },\r\n    {\r\n        ItemKey: \"Hours / PTO\",\r\n        ItemDisplayName: \"Hours / PTO\",\r\n        ItemIconName: \"Calendar\",\r\n        ItemScreen: scrWeeklyHours,\r\n        ItemType: \"Button\",\r\n        ItemOpen: false,\r\n        ItemParentKey: Blank()\r\n    }\r\n    /*,\r\n    {\r\n        ItemKey: \"Admin\",\r\n        ItemDisplayName: \"Admin\",\r\n        ItemIconName: \"Document\",\r\n        ItemScreen: scrAdmin,\r\n        ItemType: \"Button\",\r\n        ItemOpen: false,\r\n        ItemParentKey: Blank()\r\n    }\r\n    ,\r\n    \r\n        {\r\n        ItemKey: \"Onboarding\",\r\n        ItemDisplayName: \"Onboarding\",\r\n        ItemIconName: \"People\",\r\n        ItemScreen: scrOnboarding,\r\n        ItemType: \"Button\",\r\n        ItemOpen: false,\r\n        ItemParentKey: Blank()\r\n    }*/\r\n        \r\n);\r\n\r\n\r\nIf(\r\n   varIsAdmin,\r\n   Collect(\r\n       NavCollection,\r\n       {\r\n           ItemKey: \"Admin\",\r\n           ItemDisplayName: \"Admin\",\r\n           ItemIconName: \"Document\",\r\n           ItemScreen: scrAdmin,\r\n           ItemType: \"Button\",\r\n           ItemOpen: false,\r\n           ItemParentKey: Blank()\r\n       }\r\n   )\r\n);\r\n\r\n\r\n// 1. Get current user and today\r\n\r\nSet(varToday, Today());\r\n// 2. Check if we already logged an \"AppOpened\" for this user today\r\nSet(\r\n   varExistingUsage,\r\n   LookUp(\r\n       AppUsageLog,\r\n       UserEmail = varCurrentStaff.Email &&\r\n       LogDate = varToday &&\r\n       Title = \"AppOpened\"\r\n   )\r\n);\r\n// 3. If not, create one log row\r\nIf(\r\n   IsBlank(varExistingUsage),\r\n   Patch(\r\n       AppUsageLog,\r\n       Defaults(AppUsageLog),\r\n       {\r\n           Title: \"AppOpened\",\r\n           UserEmail: varCurrentStaff.Email,\r\n           UserName: varCurrentStaff.FullName,\r\n           LogDate: varToday\r\n       }\r\n   )\r\n);"
    StartScreen: =scrAllDeliverables
    Theme: =PowerAppsTheme
